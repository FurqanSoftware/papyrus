<!doctype html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Papyrus</title>

		<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css">
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.11.0/codemirror.min.css">
	</head>

	<body>
		<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/js/bootstrap.min.js"></script>
		<script src="//cdnjs.cloudflare.com/ajax/libs/codemirror/5.11.0/codemirror.min.js"></script>
		<script src="/assets/glue.js"></script>
		<script src="/assets/ot.js"></script>

		<script type="text/javascript">
			window.SYNC_DELAY = 100

			function codemirrorDocLength(doc) {
				return doc.indexFromPos({ line: doc.lastLine(), ch: 0 }) + doc.getLine(doc.lastLine()).length
			}

			function opsTransformIndex(ops, i) {
				var ip = i
				var ls = 0
				ops.forEach(function(u) {
					if(ls >= i) {
						return
					}
					switch(opType(u)) {
					case 'retain':
						ls += opSpan(u)
						break

					case 'insert':
						ip += opSpan(u)
						ls += opSpan(u)
						break

					case 'delete':
						ip -= opSpan(u)
						ls += opSpan(u)
						break
					}
				})
				return ip
			}

			function changeToOps(doc, ch) {
				var rl = doc.indexFromPos(ch.from)
				var d = -ch.removed.reduce(function(m, v) { return m+v.length+1 }, -1)
				var i = ch.text.join('\n')
				var rr = codemirrorDocLength(doc) - rl - i.length
				return [rl, d, i, rr].filter(function(v) {
					return !!v
				})
			}

			var mirror = CodeMirror(document.body)
			var opsBuf = null
			var opsWait = null
			var opsWaitID = ""
			var opsRoot = 0
			mirror.on('changes', function(event, changes) {
				changes.forEach(function(ch) {
					if(ch.origin === 'setValue') {
						return
					}
					if(opsBuf === null) {
						opsBuf = changeToOps(event.doc, ch)
					} else {
						opsBuf = opsCompose(opsBuf, changeToOps(event.doc, ch))
					}
				})
			})

			var socket = glue()
			socket.send('subscribe 1')
			socket.onMessage(function(data) {
				var fields = [data.substr(0, data.indexOf(' ')), data.substr(data.indexOf(' ')+1)]
				switch(fields[0]) {
				case 'change':
					var data = JSON.parse(fields[1])
					if(data.id === "") {
						console.log('initial', data.ops)
						mirror.getDoc().setValue(blobApply(mirror.getDoc().getValue(), data.ops))

					} else if(data.id === opsWaitID) {
						console.log('acknowledgement', data.ops)
						opsWait = null

					} else {
						console.log('external', data.ops)

						if(opsBuf !== null) {
							var e = opsTransform(opsBuf, data.ops)
							opsBuf = e[0]
							data.ops = e[1]
						}

						var doc = mirror.getDoc()
						var selection = [doc.indexFromPos(doc.getCursor('anchor')), doc.indexFromPos(doc.getCursor('head'))]
						doc.setValue(blobApply(doc.getValue(), data.ops))
						doc.setSelection(doc.posFromIndex(opsTransformIndex(data.ops, selection[0])), doc.posFromIndex(opsTransformIndex(data.ops, selection[1])))
					}
					opsRoot = data.root
					break

				case 'subscribed':
					ready = true
					break
				}
			})

			var ready = false
			function sync() {
				if(opsBuf === null || opsBuf.length === 0 || opsWait !== null) {
					setTimeout(function() {
						sync()
					}, window.SYNC_DELAY)
					return
				}

				opsWait = opsBuf
				opsBuf = null
				opsWaitID = new Date().getTime()+'-'+Math.round(1e9*Math.random())
				socket.send('change '+JSON.stringify({
					id: opsWaitID,
					root: opsRoot,
					ops: opsWait
				}))
				sync()
			}
			sync()
		</script>
	</body>
</html>
